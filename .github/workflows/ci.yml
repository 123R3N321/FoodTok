name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    env:
      COVERAGE_MIN: 75
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        cd ecs_app
        pip install -r requirements.txt

    - name: Prepare local data directories (DynamoDB/LocalStack)
      run: |
        mkdir -p local/dynamo local/localstack
        chmod -R 777 local/dynamo local/localstack

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build backend services
      run: make backend-build

    - name: Start backend services
      run: make backend-up

    - name: Wait for infrastructure services to be ready
      run: |
        sleep 10
        timeout=60
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          dynamo_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000 2>/dev/null || echo "000")
          localstack_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4566/_localstack/health 2>/dev/null || echo "000")
          
          if [ "$dynamo_code" = "400" ] && [ "$localstack_code" = "200" ]; then
            break
          fi
          
          sleep 3
          elapsed=$((elapsed + 3))
        done
        
        if [ $elapsed -ge $timeout ]; then
          echo "Infrastructure failed to become ready"
          docker compose -p foodtok-backend -f docker-compose.backend.yml ps
          docker compose -p foodtok-backend -f docker-compose.backend.yml logs dynamo --tail=20
          docker compose -p foodtok-backend -f docker-compose.backend.yml logs localstack --tail=20
          exit 1
        fi

    - name: Initialize DynamoDB tables and S3 buckets
      run: |
        sleep 5
        docker compose -p foodtok-backend -f docker-compose.backend.yml run --rm --no-deps local_config

    - name: Wait for backend to be healthy
      run: |
        timeout=60
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          if curl -f http://localhost:8080/api/helloECS > /dev/null 2>&1; then
            break
          fi
          sleep 3
          elapsed=$((elapsed + 3))
        done
        if [ $elapsed -ge $timeout ]; then
          echo "Backend failed to become healthy"
          docker compose -p foodtok-backend -f docker-compose.backend.yml logs
          exit 1
        fi

    - name: Wait for seed data
      run: |
        timeout=60
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          response=$(curl -s http://localhost:8080/api/restaurants || echo "")
          if [ -n "$response" ] && echo "$response" | grep -q "restaurantId"; then
            break
          fi
          sleep 3
          elapsed=$((elapsed + 3))
        done

    - name: Run backend tests
      run: make backend-test
      env:
        FOODTOK_SMOKE_MANAGE_STACK: 0
        FOODTOK_SMOKE_BASE_URL: http://localhost:8080/api

    - name: Run backend tests with coverage and enforce minimum
      run: |
        cd ecs_app && pytest tests/api/ -v --cov=. --cov-report=term --cov-report=xml --cov-report=html --cov-fail-under=${COVERAGE_MIN:-75}
      env:
        FOODTOK_SMOKE_MANAGE_STACK: 0
        FOODTOK_SMOKE_BASE_URL: http://localhost:8080/api

    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-html-report
        path: ecs_app/htmlcov/
        retention-days: 7

    - name: Show backend logs on failure
      if: failure()
      run: |
        docker compose -p foodtok-backend -f docker-compose.backend.yml logs

    - name: Cleanup
      if: always()
      run: make backend-down

